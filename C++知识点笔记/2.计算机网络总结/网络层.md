#### 网络层功能

提供路由选择、分组转发，数据从源端到目的端的传输

#### IP协议

**IP协议介绍及特点**

IP协议是TCP/IP协议簇中的核心协议，也是TCP/IP的载体。所有的TCP，UDP，ICMP及IGMP数据都以IP数据报格式传输。

**IP协议特点：**IP提供不可靠的，无连接的数据传送服务。
（1）不可靠指它不能保证IP数据报能成功到达目的地。
IP仅提供最好的传输服务。当发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法：丢弃该数据报，然后发送ICMP消息给信源。任何要求的可靠性必须由上层来提供。

（2）无连接指IP并不维护任何关于后续数据报的状态信息。
每个数据报的处理是相互独立的。IP数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报（先是A，然后是B）每个数据报都是独立的进行路由选择，可能选择不同的路线，因此B可能在A到达之前先到达。 

IP协议解决的问题：不相邻节点传输

<img src="C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\ip协议解决的问题.png" alt="ip协议解决的问题" style="zoom: 67%;" />

主机：是配有IP地址, 但是不进行路由控制的设备； 
路由器: 即配有IP地址, 又能进行路由控制； 
节点: 主机和路由器的统称；

**IP地址**

IP地址长度为32位，常分成4个8位
IP地址常使用点分十进制来表示(0~ 255.0~ 255.0~255.0~255)

<img src="C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\IP地址.png" alt="IP地址" style="zoom:67%;" />

**IP数据报格式**

![IP报文格式](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\IP报文格式.png)



**IP地址划分**

|               字段               | 解释                                                         |
| :------------------------------: | ------------------------------------------------------------ |
|        4位版本号(version)        | 指定IP协议的版本, 对于IPv4来说，就是4                        |
|    4位头部长度(header length)    | IP头部的长度是多少个4B, 也就是 length * 4 的字节数. 4bit表示最大的数字是15, 因此IP头部最大长度是60字节 |
|   8位服务类型(Type Of Service)   | 位优先权字段(已经弃用), 4位TOS字段, 和1位保留字段(必须置0). 4位TOS（最小延时, 最大吞吐量, 最高可靠性, 最小成本),只能选其一. |
|     16位总长度(total length)     | IP数据报整体占多少个字节 单位1B                              |
|           16位标识(id)           | 唯一的标识主机发送的报文. 如果IP报文在数据链路层被分片了, 那么每一个片里面的这个id是相同的 |
|           3位标志字段            | 第一位保留，第二位DF=1禁止分片，DF=0允许分片，第三位MF=1，后面还有分片，MF=0，最后一个分片/无分片 |
| 13位分片偏移(framegament offset) | 是分片相对于原始IP报文开始处的偏移. 其实就是在表示当前分片在原报文中处在哪个位置8B为单位(除最后一个都是8的倍数) |
|  8位生存时间(Time To Live, TTL)  | 数据报到达目的地的最大报文跳数                               |
|             8位协议              | 表示上层协议的类型 TCP/UDP                                   |
|          16位头部校验和          | 使用CRC进行校验, 来鉴别头部是否损坏，仅对首部进行校验        |
|     32位源地址和32位目标地址     | 表示发送端和接收端                                           |
|             选项字段             | 不定长, 最多40字节                                           |

**IP地址分片**

总长度单位是1B
片偏移单位是8B
首部长度单位是4B

一种八片首饰

![IP地址分片](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\IP地址分片.png)

#### 子网划分

IP地址： 网络号+主机号

![IP地址1](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\IP地址1.png)

所有IP 地址可以分为五类，如下： 

<img src="C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\分类的IP地址.png" alt="分类的IP地址" style="zoom:67%;" />

![分类IP2](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\分类IP2.png)

其中注意127.0.0.1，通常被称为**本地回环地址**(Loopback Address),不属于任何一个有类别地址类。它代表设备的本地虚拟接口，所以默认被看作是永远;不会宕掉的接口。在Windows操作系统中也有相似的定义，所以通常在安装网-卡前就可以ping通这个本地回环地址。一般都会用来检查本地网络协议、基本数据接口等是否正常的。

主机号为**全1**表示广播地址，用于给同一个链路中相互连接的所有主机发送数据包

主机号**全0**表示当前网络段(代表这个局域网)，不可分配为特定主机

**分类的IP地址的弱点:**
1.IP地址空间的利用率有时很低。
2.两级IP地址不够灵活。

**子网**

![子网](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\子网.png)

**子网掩码**

它是一种用来指明一个IP地址的哪些位标识的是主机所在的子网，以及哪些位标识的是主机的位掩码。子网掩码不能单独存在，它必须结合IP地址一起使用。子网掩码只有一个作用，就是将某个IP地址划分成网络号和主机号两部分，如图所示，该单位内部划分了三个子网，现在外面有个消息要传给145.13.3.10，先到达总的这个路由，经过子网掩码（11111111.11111111.11111111.00000000）跟IP（145.13.3.10）相与得到（145.13.3.0），才能得到传给哪个子网

<img src="C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\子网掩码作用.png" alt="子网掩码作用" style="zoom:67%;" />

子网掩码和IP地址一样，都是32位，连续的1和连续的0组成
网络号子网号全1，主机号全0

如图所示，子网号8位

![子网掩码](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\子网掩码.png)

普通网络中转发（忽略从IP到MAC地址的过程）

路由表：目的IP地址 | 下一跳IP地址

如下图，

在A中存储的 C的IP | E的IP

在E中存储的 C的IP | F的IP

在F中存储的 C的IP | C的IP

<img src="C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\IP转发.png" alt="IP转发" style="zoom:67%;" />

STEP2

E的数据链路层接收到数据帧，把帧数据交给网络层
E查询路由表，发现下一跳为F
E把数据报交给数据链路层，并告知目的MAC地址为F
E的数据链路层封装数据帧并发送

STEP3

F的数据链路层接收到数据帧，把帧数据交给网络层
F查询路由表，发现下一-跳为C
F把数据报交给数据链路层,并告知目的MAC地址为C
F的数据链路层封装数据帧并发送

在划分子网的网络中转发

多了一步IP跟子网掩码与操作

![子网时转发](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\子网时转发.png)

子网划分，在一定程度上缓解了IP地址不够用的问题，提高了利用率，减少了浪费，但IP地址的绝对上限并没有增加，仍然不够用，会有三种方式来解决IP地址不够用的问题：
1. 动态分配IP地址: 只给接入网络的设备分配IP地址. 因此同一个MAC地址的设备, 每次接入互联网中得到的IP地址不一定是相同的（DHCP）
2. NAT技术
3. IPv6: IPv6用16字节128位来表示一个IP地址; 但是目前IPv6还没有普及

**NAT技术**

私有IP：如果一个组织内部组建局域网,IP地址只用于局域网内的通信,而不直接连到Internet上

公有IP：全局IP

1. NAT技术是当前解决IP地址不够用的主要手段，是路由器的一个重要功能。
2. NAT能够将私有IP对外通信时转为全局IP。也就是就是一种将私有IP和全局IP相互转化的技术方法。

内网中的主机需要和外网进行通信时，路由器将IP首部中的IP地址进行替换，替换成WAN口IP，逐级替换，最终数据包中的IP地址成为一个公网IP，这种技术被称为NAT。

如下图 192.168.0.3要发消息给213.18.2.4

先经过NAT路由器，他查NAT转换表将192.168.0.3:30000，替换成172.38.1.5:40001，然后发送

213.18.2.4收到以后在将消息返回给172.38.1.5:40000，然后NAT路由器在替换成192.168.0.3:30000

![NAT](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\NAT.png)

#### ARP

以太网设备比如网卡都有自己唯一的MAC地址，它们是以MAC地址传输以太网数据包的，但是它们却识别不了IP包中的IP地址，所以我们在以太网中进行IP通信的时候就需要一个协议来建立IP地址与MAC地址的对应关系，以使数据包能发到一个确定的地方去,这就是ARP(地址解析协议)
**作用**：ARP协议建立了**主机 IP地址** 和 **MAC地址** 的映射关系。
在网络通讯时,源主机的应用程序知道目的主机的IP地址和端口号,却不知道目的主机的硬件地址；数据包首先是被网卡接收到再去处理上层协议的，如果接收到的数据包的硬件地址与本机不符，则直接丢弃。因此在通讯前必须获得目的主机的硬件地址。

ARP报文格式

![ARP报文格式](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\ARP报文格式.png)

（1）源MAC地址,目的MAC地址在以太网首部和ARP请求中各出现一次。
（对于链路层为以太网的情况是多余的，但如果链路层是其它类型的网络则有可能是必要的）
（2）硬件类型指链路层网络类型，1为以太网
（3） 协议类型指要转换的地址类型，0x0800为IP地址
（4）硬件地址长度对于以太网地址为6字节;
（5）协议地址长度对于和IP地址为4字节;
（6）op字段为1表示ARP请求，op字段为2表示ARP应答
**ARP过程：**

（0) 检查ARP高速缓存，有对应表项则写入MAC帧

（1）没有对应的MAC，则用目的MAC地址为FF-FF FFFF的帧封源主机发出ARP请求，比如，询问”IP地址是192.168.0.1的主机的硬件地址是多少”；将这个请求广播到本地网段，同一个局域网的都可以收到(以太网首部的硬件地址填FF:FF:FF:FF:FF:FF，表示广播)；
（2)目的主机接受到广播的ARP请求，发现其中的IP地址与本机相同，则发送一个ARP应答数据包给源主机，将自己的硬件地址填写在应答包中。
（3）每台主机都维护一个ARP缓存表，可以用arp -a命令查看（下文会介绍）。缓存表中的表项有过期时间(一般为20分钟)，如果20分钟内没有再次使用某个表项，则该表项失效，下次还要发ARP请求来获得目的主机的硬件地址。

**举例：**

图中源主机mac：00 05 5d 61 58 a8 源IP c0 a8 00 37

目的主机mac未知 目的主机IP c0 a8 00 02

通过ARP协议去寻找这个mac并填入缓存表中

<img src="C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\ARP举例.png" alt="ARP举例" style="zoom:67%;" />

<img src="C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\ARP举例1.png" alt="ARP举例1" style="zoom:67%;" />

**ARP缺点**

ARP协议是建立在信任局域网内所有结点的基础上的，它很高效，但却不安全。它是无状态的协议，不会检查自己是否发过请求包，也不管（其实也不知道）是否是合法的应答，只要收到目标MAC是自己的ARP reply包或arp广播包（包括ARP request和ARP  reply），都会接受并缓存。这就为ARP欺骗提供了可能，恶意节点可以发布虚假的ARP报文从而影响网内结点的通信，甚至可以做“中间人

**ARP代理**

代理ARP（Proxy-arp）的原理就是当出现跨网段的ARP请求时，路由器将自己的MAC返回给发送ARP广播请求发送者，实现MAC地址代理（善意的欺骗），最终使得主机能够通信。

![ARP代理](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\ARP代理.png)

图中R1和R3处于不同的局域网，R1和R3在相互通信时，R1先发送了一个ARP广播数据包，请求R3的mac地址，但是由于R1是12.1.1.0网段，而R3是13.1.1.0网段，R1和R3之间是跨网段访问的，也就是说R1的ARP请求会被R2拦截到，然后R2会封装自己的mac地址为目的地址发送一个ARP回应数据报给R1（善意的欺骗），然后R2就会代替R1去访问R3。
  整个过程R1以为自己访问的是R3，实际上真正去访问R3的是R2，R1却并不知道这个代理过程，这就是所谓的ARP代理，通常用于跨网段访问。

代理ARP的使用场景为：1. 没有路由功能的主机，2. 有路由功能，目的地指向本地出口

**免费ARP**

指主机发送 ARP 查找自己的 IP 地址，即数据链路层 SIP=DIP
作用有两个：
1）一个主机使用免费 ARP 确定是有存在有其他主机设置了相同的 IP 地址
2）如果发送免费 ARP 的主机改变了 MAC 地址，可以通过发送免费 ARP 的方式告知其他
主机端更新 ARP 表

#### ICMP（网际控制报文协议）

**ICMP协议是一个网络层协议。** 
 一个新搭建好的网络，往往需要先进行一个简单的测试，来验证网络是否畅通；但是IP协议并不提供可靠传输。如果丢包了，IP协议并不能通知传输层是否丢包以及丢包的原因。  所以我们就需要一种协议来完成这样的功能ICMP协议。

ICMP协议的**功能**主要有： 

1. 确认IP包是否成功到达目标地址 
2. 通知在发送过程中IP包被丢弃的原因 

使用时需要注意

1. ICMP是基于IP协议工作的，但是它并不是传输层的功能，因此仍然把它归结为网络层协议 
2. ICMP只能搭配IPv4使用，如果是IPv6的情况下, 需要是用ICMPv6

**分类**：ICMP差错报文、ICMP询问报文

**报文格式**

<img src="C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\ICMP格式.png" alt="ICMP格式" style="zoom: 67%;" />

| 类型   | 说明                                                         |
| ------ | ------------------------------------------------------------ |
| 类型   | 占一字节，标识ICMP报文的类型，从类型值来看ICMP报文可以分为两大类。第一类是取值为1~127的差错报文，第2类是取值128以上的询问信息报文 |
| 代码   | 占一字节，标识对应ICMP报文的代码。它与类型字段一起共同标识了ICMP报文的详细类型 |
| 校验和 | 这是对包括ICMP报文数据部分在内的整个ICMP数据报的校验和，以检验报文在传输过程中是否出现了差错（其计算方法与在我们介绍IP报头中的校验和计算方法是一样的） |

**差错报文**

终点不可达

时间超过：TTL=0还没到达

参数问题：首部字段问题，当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。

重定向：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器，**比如**

1）主机发送 IP 数据报给 R1，因为主机的默认路由指向的下一跳是 R1。
2） R1 收到数据报并且检查它的路由表，发现 R2 是发送该数据报的下一跳。当他将数据报发送给 R2 的时候，发现发送的接口与接受的端口是一样的，因此同时发送一个 ICMP 重定向报文给主机。
3） R1 接受到 ICMP 重定向报文后，接下来的数据报就发送给 R2，而不再发送给 R1。

**注意**：

重定向报文只能有路由器生成。
重定向报文是为主机而不是为路由器使用的。

<img src="C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\发生重定向.png" alt="发生重定向" style="zoom:67%;" />

差错的类型不同体现在 报文的**代码**字段

![ICMP代码字段](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\ICMP代码字段.png)

差错报文的封装：将收到的IP报的首部和前8个字节取出，作为ICMP的数据字段，在加上ICMP的首部8个字节，形成完整的ICMP差错报文，在加上IP的首部形成完整的数据报

![ICMP差错报文](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\ICMP差错报文.png)

**什么情况不返回差错报文**

1）ICMP 差错报文。
2） 目的地址是广播地址或者多播地址的 IP 数据报。
3） 链路层广播的数据报
4） 不是 IP 分片的第一片
5） 源地址不是单个主机的数据包。



**询问报文**

1.回送请求和回答报文：主机或路由器向特定目的主机发出的询问，收到此报文的主机必须给源主机或路由
器发送ICMP回送回答报文。测试目的站是否可达以及了解其相关状态。（0、8）

2.时间戳请求和回答报文：请某个主机或路由器回答当前的日期和时间。用来进行时钟同步和测量时间。（13、14）

**ICMP的两个应用**

**1.ping**

1. A 电脑（ `192.168.2.135`）发起 `ping`请求， `ping192.168.2.179`

2. A 电脑广播发起 `ARP`请求，查询 `192.168.2.179`的 MAC地址。

3. B 电脑应答 `ARP`请求，向 A电脑发起单向应答，告诉 A电脑自己的 MAC地址为 `90:A4:DE:C2:DF:FE`

4. 知道了 MAC地址后，开始进行真正的 ping请求，由于 B电脑可以根据A电脑发送的请求知道 **源 MAC地址**，所以就可以根据源 MAC地址进行响应了

ping的作用

（1）能验证网络的连通性
（2）会统计响应时间和TTL(IP包中的Time To Live，生存周期)
ping如何工作
（1）ping命令会先发送一个 ICMP Echo Request给对端（类型字段值为8的ICMP报文）
（2）对端接收到之后, 会返回一个ICMP Echo Reply（类型字段值为0的ICMP报文）
（3）若没有返回，就是超时了，会认为指定的网络地址不存在。

**2.Traceroot**

TTL经过一跳就减去1，ICMP发送TTL分别为1,2,3,4....的报文，如果没到达终点就会超时，从而返回一个携带路径中IP的报文回来。

TraceRoute通过发送UDP报文，设置目的端口为一个不可能的值，将IP首部中的TTL分别设置从1到N，每次逐个增加，如果收到端口不可达，说明到达目的主机，如果是因为TTL跳数超过，路由器会发送主机不可达的ICMP报文。

#### 路由算法

路由选择，解决下一跳在哪的问题，通过算法将应该去哪填入路由表中

路由算法分为：静态和动态

其中动态分为：全局性（链路状态路由算法OSPF，掌握整个网络拓扑）、分散性（距离向量路由算法RIP，只能掌握相连邻居的信息）

**内部网关协议（OSPF、RIP）**

**RIP**是一种分布式的基于距离向量的内部网关路由选择协议，通过广播UDP报文来交换路由信息。

RIP缺点：坏消息传的慢，更新时间过长（每隔30s才更新一次，要更新很多次才能说明一个节点不可达），网络规模小

RIP优点：简单、开销小

**OSPF**是一个内部网关协议，要交换的信息量较大，应使报文的长度尽量短，所以不使用传输层协议( 如UDP或TCP)，而是直接采用IP。

**外部网关协议（BGP）**
BGP是一个外部网关协议，在不同的自治系统之间交换路由信息，由于网络环境复杂，需要保证可靠传输，所以采用TCP。

![路由协议](C:\Users\ZJH\Desktop\课件\计算机网络总结\图片\路由协议.png)